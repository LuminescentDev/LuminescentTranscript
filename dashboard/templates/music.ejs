<%- include("partials/header", { bot, user, path, title: "Pup Music Player" }) %>
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.4.0/css/font-awesome.min.css">
<h1 style="text-align: center; padding:10px">Playing Now</h1>
<h4 style="text-align: center; word-wrap: break-word;" id="vcname">No voice channel</h4>

<div id="main">
  <div class="centered">
    <img src="/assets/images/musicplaceholder.png" style="min-width: 20%; max-width: 80%; border-radius: 3%; margin:2rem" id="cover">
  </div>
  <div style="margin-bottom:1rem" class="centered">
    <h1 style="text-align: center; width: 80%;" id="title">Not playing anything!</h1>
  </div>
  <div style="margin-bottom:1rem" class="centered">
    <h4 style="text-align: center; width: 80%;" id="artist">Artist not specified</h4>
  </div>  
</div>

<div id="equalizer" style="display: none;">
  <div class="centered">
    <input type="range" min="-100" id="band0" oninput="eq(event);" orient="vertical">
    <input type="range" min="-100" id="band1" oninput="eq(event);" orient="vertical">
    <input type="range" min="-100" id="band2" oninput="eq(event);" orient="vertical">
    <input type="range" min="-100" id="band3" oninput="eq(event);" orient="vertical">
    <input type="range" min="-100" id="band4" oninput="eq(event);" orient="vertical">
    <input type="range" min="-100" id="band5" oninput="eq(event);" orient="vertical">
    <input type="range" min="-100" id="band6" oninput="eq(event);" orient="vertical">
    <input type="range" min="-100" id="band7" oninput="eq(event);" orient="vertical">
    <input type="range" min="-100" id="band8" oninput="eq(event);" orient="vertical">
    <input type="range" min="-100" id="band9" oninput="eq(event);" orient="vertical">
    <input type="range" min="-100" id="band10" oninput="eq(event);" orient="vertical">
    <input type="range" min="-100" id="band11" oninput="eq(event);" orient="vertical">
    <input type="range" min="-100" id="band12" oninput="eq(event);" orient="vertical">
    <input type="range" min="-100" id="band13" oninput="eq(event);" orient="vertical">
    <input type="range" min="-100" id="band14" oninput="eq(event);" orient="vertical">  
  </div>
</div>

<div id="lyricsview" style="display: none;">
  <div class="centered">
    <div class="centered" style="width: 80%; padding: 15px">
      <h1 id="lyrics" style="text-align: center;">Lyrics not found.</h1>
    </div>
  </div>
  <div class="centered">
    <input type="range" value="0" id="scroll" oninput="updatelyric(); document.getElementById('hint').innerText = '';" style="width:45%;">
  </div>
  <h7 id="hint" class="centered">Drag the bar above to go through the lyrics</h7>
  <br>
</div>

<div class="centered">
  <div id="minimized" href="#" class="queueitem" style="width:60%; display:none;">
    <img src="/assets/images/musicplaceholder.png" style="height:50px; margin:10px; border-radius:5px;" id="mincover" ></img>
    <h6 style="height:70px; width:60%; display: flex; flex-wrap: wrap; align-items: center; overflow: hidden;" id="mintitle">Not playing anything!</h6>
  </div>
</div>

<div class="centered disabled" id="progresscontainer">
  <h5 id="pos" style="padding:15px; margin:0;">0:00</h5>
    <input type="range" disabled id="progress" value="0" oninput="seeksong(event);" style="width:45%;">
  <h5 id="total" style="padding:15px; margin:0;">0:00</h5>
</div>
<div class="centered" style="margin:1rem;">
  <a href="#" class="mediacontrols" onclick="togglelyrics();"><img id="mic" src="/assets/icons/mic.svg"></a>
  <a href="#" class="mediacontrols disabled" id="shuffle" onclick="shufflequeue();"><img src="/assets/icons/shuffle.svg"></a>
  <a href="#" class="mediacontrols disabled" id="playbtn" onclick="toggleplaypause();"><img id="play" src="/assets/icons/play.svg"></a>
  <a href="#" class="mediacontrols disabled" id="skip" onclick="skipsong();"><img src="/assets/icons/skip-forward.svg"></a>
  <a href="#" class="mediacontrols disabled" id="eqbtn" onclick="toggleeq()"><img id="sliders" src="/assets/icons/sliders.svg"></a>
</div>
<div class="centered disabled" id="volumecontainer">
  <h5 style="padding:15px; margin:0;"><img src="/assets/icons/volume-x.svg"></h5>
    <input type="range" disabled id="volume" oninput="changevolume(event);" style="width:40%;" max=100>
  <h5 style="padding:15px; margin:0;"><img src="/assets/icons/volume-2.svg"></h5>
</div>

<div class="centered" id="djrole">
  <h5 style="padding:15px; margin:0;" id="dj">Users without the DJ role have limited access.</h5>
</div>

<div id="queuecont" class="disabled" style="margin-top:3rem;"></div>
<script>
  // functions
  function sleep(ms) { return new Promise(res => setTimeout(res, ms)); }
  async function getMusicInfo() {
    await sleep(250);
    ws.send('music info for: <%=user.id%>');
  }
  function changevolume(event) { ws.send(`volume change: <%=user.id%> / ${event.srcElement.value}`); }
  function seeksong(event) { ws.send(`seek song: <%=user.id%> / ${event.srcElement.value}`); }
  function skipsong() {
    ws.send('skip song: <%=user.id%>');
    getMusicInfo();
  }
  function prevsong() {
    ws.send('prev song: <%=user.id%>');
    getMusicInfo();
  }
  function skipto(index) {
    ws.send(`skip to: <%=user.id%> / ${index}`);
    getMusicInfo();
  }
  function shufflequeue() {
    ws.send('shuffle queue: <%=user.id%>');
    getMusicInfo();
  }
  function toggleplaypause() {
    if (play.src.includes('play')) play.src = '/assets/icons/pause.svg';
    else play.src = '/assets/icons/play.svg';
    ws.send('playpause: <%=user.id%>');
    getMusicInfo();
  }
  function convert(duration) {
    let seconds = parseInt((duration / 1000) % 60);
    let minutes = parseInt((duration / (1000 * 60)) % 60);
    const hours = parseInt((duration / (1000 * 60 * 60)) % 24);
    seconds = (seconds < 10) ? '0' + seconds : seconds;
    if (duration < 3600000) {
      return minutes + ':' + seconds ;
    }
    else {
      minutes = (minutes < 10) ? '0' + minutes : minutes;
      return hours + ':' + minutes + ':' + seconds ;
    }
  }
  function updatelyric() {
    lyrictext.innerText = lyrics[scroll.value];
    if (!lyrictext.innerText) lyrictext.innerText = '•••';
  }
  function togglelyrics() {
    if (lyricsview.style.display == 'none') {
      lyricsview.style.display = 'block';
      document.getElementById('mic').src = '/assets/icons/music.svg';
    }
    else {
      lyricsview.style.display = 'none';
      document.getElementById('mic').src = '/assets/icons/mic.svg';
    }
  }
  function eq(event) {
    const bands = [
      document.getElementById('band0').value / 100,
      document.getElementById('band1').value / 100,
      document.getElementById('band2').value / 100,
      document.getElementById('band3').value / 100,
      document.getElementById('band4').value / 100,
      document.getElementById('band5').value / 100,
      document.getElementById('band6').value / 100,
      document.getElementById('band7').value / 100,
      document.getElementById('band8').value / 100,
      document.getElementById('band9').value / 100,
      document.getElementById('band10').value / 100,
      document.getElementById('band11').value / 100,
      document.getElementById('band12').value / 100,
      document.getElementById('band13').value / 100,
      document.getElementById('band14').value / 100,
    ];
    ws.send(`eq: <%=user.id%> / ${bands}`);
  }
  function toggleeq() {
    if (equalizer.style.display == 'none') {
      equalizer.style.display = '';
      minimized.style.display = '';
      main.style.display = 'none';
      document.getElementById('sliders').src = '/assets/icons/music.svg';
    }
    else {
      equalizer.style.display = 'none';
      minimized.style.display = 'none';
      main.style.display = '';
      document.getElementById('sliders').src = '/assets/icons/sliders.svg';
    }
  }

  // variables
  const body = document.getElementsByTagName('body')[0];
  const vcname = document.getElementById('vcname');
  const cover = document.getElementById('cover');
  const mincover = document.getElementById('mincover');
  const title = document.getElementById('title');
  const mintitle = document.getElementById('mintitle');
  const artist = document.getElementById('artist');
  const bar = document.getElementById('progress');
  const posLabel = document.getElementById('pos');
  const totalLabel = document.getElementById('total');
  const play = document.getElementById('play');
  const volume = document.getElementById('volume');
  const queue = document.getElementById('queuecont');
  const scroll = document.getElementById('scroll');
  const ws = new WebSocket('<%=wsurl%>');
  const lyricsview = document.getElementById('lyricsview');
  const lyrictext = document.getElementById('lyrics');
  const main = document.getElementById('main');
  const minimized = document.getElementById('minimized');
  let lyrics = ['Lyrics not found.'];

  // websocket
  ws.onopen = function open() {
    getMusicInfo();
    setInterval(() => getMusicInfo(), 5000);
  };

  // update song progress each sec
  setInterval(() => {
    if (play.src.includes('pause')) {
      bar.value = parseInt(bar.value) + 1000;
      posLabel.innerText = convert(bar.value);
      totalLabel.innerText = convert(bar.max - bar.value);
    }
  }, 1000);

  // data handling
  let balls = false;
  ws.onmessage = async function message(data) {
    const player = data.data instanceof Blob ? null : JSON.parse(data.data);

    if (player.djrole) document.getElementById('dj').innerText = document.getElementById('dj').innerText.replace('DJ', player.djrole);
    if (player.hasdj) {
      document.getElementById('djrole').style.display = 'none';
      bar.disabled = false;
      volume.disabled = false;
      document.getElementById('volumecontainer').classList.remove('disabled');
      document.getElementById('progresscontainer').classList.remove('disabled');
      document.getElementById('shuffle').classList.remove('disabled');
      document.getElementById('playbtn').classList.remove('disabled');
      document.getElementById('skip').classList.remove('disabled');
      document.getElementById('eqbtn').classList.remove('disabled');
      queue.classList.remove('disabled');
    }
    else if (!bar.disabled) {
      document.getElementById('djrole').style.display = '';
      bar.disabled = true;
      volume.disabled = true;
      document.getElementById('volumecontainer').classList.add('disabled');
      document.getElementById('progresscontainer').classList.add('disabled');
      document.getElementById('shuffle').classList.add('disabled');
      document.getElementById('playbtn').classList.add('disabled');
      document.getElementById('skip').classList.add('disabled');
      document.getElementById('eqbtn').classList.add('disabled');
      queue.classList.add('disabled');
    }

    if (!balls) {
      document.getElementById('band0').value = player.bands[0] * 100,
      document.getElementById('band1').value = player.bands[1] * 100,
      document.getElementById('band2').value = player.bands[2] * 100,
      document.getElementById('band3').value = player.bands[3] * 100,
      document.getElementById('band4').value = player.bands[4] * 100,
      document.getElementById('band5').value = player.bands[5] * 100,
      document.getElementById('band6').value = player.bands[6] * 100,
      document.getElementById('band7').value = player.bands[7] * 100,
      document.getElementById('band8').value = player.bands[8] * 100,
      document.getElementById('band9').value = player.bands[9] * 100,
      document.getElementById('band10').value = player.bands[10] * 100,
      document.getElementById('band11').value = player.bands[11] * 100,
      document.getElementById('band12').value = player.bands[12] * 100,
      document.getElementById('band13').value = player.bands[13] * 100,
      document.getElementById('band14').value = player.bands[14] * 100;
    }
    balls = true;

    lyrics = player.lyrics.split('\n');
    scroll.max = lyrics.length - 1;
    updatelyric();
    volume.value = player ? player.volume : null;
    vcname.innerText = player ? player.voiceChannelName : null;
    if (player && player.current) {
      if (cover.src != player.current.img) {
        cover.src = player.current.img;
        mincover.src = player.current.img;
        if (player.current.color) {
          body.style.backgroundColor = `rgb(${player.current.color.join(', ')})`;
          body.style.backgroundImage = `linear-gradient(315deg, #000000, rgb(${player.current.color.join(', ')}), #000000)`;
          minimized.style.backgroundColor = `rgb(${player.current.color.join(', ')})`;
        }
        bar.max = player.current.duration;
        title.innerText = player.current.title.split('\n')[0];
        mintitle.innerText = player.current.title;
        artist.innerText = player.current.title.split('\n')[1];
      }
      if (bar.value != player.position) {
        console.log('Encountered position mismatch, updating...');
        bar.value = player.position;
      }
      posLabel.innerText = convert(bar.value);
      totalLabel.innerText = convert(bar.max - bar.value);
      if (!player.paused) {
        document.getElementById('queuecont').innerHTML = '';
        player.queue.forEach(track => {
          if (!track.color) track.color = [Math.floor(Math.random() * 255), Math.floor(Math.random() * 255), Math.floor(Math.random() * 255)];
          document.getElementById('queuecont').innerHTML += `
<div class="centered" style="margin:15px;">
  <a href="#" class="queueitem" onclick="skipto(${player.queue.indexOf(track)})" style="background-image: linear-gradient(90deg, rgb(${track.color.join(', ')}), rgba(${track.color.join(', ')}, 0.3));">
    <img src="${track.img}" style="height:50px; margin:10px; border-radius:5px;"></img>
    <h6 style="height:70px; width:60%; display: flex; flex-wrap: wrap; align-items: center; overflow: hidden;">${track.title.replace('\n', '<br>')}</h6>
  </a>
</div>
`;
        });
        play.src = '/assets/icons/pause.svg';
      }
      else {
        play.src = '/assets/icons/play.svg';
      }
    }
    else if (title.innerText != 'Not playing anything!') {
      queue.innerHTML = '';
      cover.src = '/assets/images/musicplaceholder.png';
      mincover.src = '/assets/images/musicplaceholder.png';
      title.innerText = 'Not playing anything!';
      mintitle.innerText = 'Not playing anything!';
      artist.innerText = 'Artist not specified';
    }
  };
</script>
<%- include("partials/footer") %>